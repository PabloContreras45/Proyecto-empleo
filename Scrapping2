from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import StaleElementReferenceException
from time import sleep
# Iniciamos el driver de Chrome para acceder a este
driver = webdriver.Chrome()

# Navegamos a la página web
driver.get("https://www.jobleads.com/es")

# Aceptamos el banner de coookies
accept_cookies_button = WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.XPATH, '//button[contains(text(), "Aceptar")]'))  # Modifica el XPATH según sea necesario
)

# Hacemos clic en el botón de "Aceptar cookies"
accept_cookies_button.click()

# Encontramos el botón de iniciar sesión y hacemos click
login_button = driver.find_element(By.XPATH, '//*[@id="__nuxt"]/div[1]/div[1]/div[1]/div/div/div[2]/button')
login_button.click()

# Esperamos hasta que el campo de correo electrónico esté presente
email_input = WebDriverWait(driver, 5).until(
    EC.presence_of_element_located((By.XPATH, '//input[@type="email" and @data-testid="login-form-email-field-ui-input"]'))
)
email_input.send_keys("cakapa61@gmail.com")

password_input = WebDriverWait(driver, 3).until(
    EC.presence_of_element_located((By.XPATH, '//input[@type="password" and @data-testid="login-form-password-field-ui-input"]'))  # Cambia el data-testid si es necesario
)
# Ingresa la contraseña
password_input.send_keys("DaB01.proyecto")

# Si tienes un botón de inicio de sesión, puedes hacer clic en él
login_button = WebDriverWait(driver, 3).until(
    EC.element_to_be_clickable((By.XPATH, '/html/body/div[4]/div/div/form/div[3]/button'))
)
login_button.click()

# Ya hemos conseguido iniciar sesión para acceder a la información oculta, ahora intentemos extraer dicha información
# Para ello, debemos ir al área de "Trabajos" y desde ahí buscar el resto

try:
    trabajos_button = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, '//a[@data-testid="app-header-jobs-menu-item"]'))
    )
    
    # Hacemos clic en el botón "Trabajos"
    trabajos_button.click()
except StaleElementReferenceException:
    print("El elemento ya no está presente en el DOM. Intentando nuevamente...")
    
    # Reencontramos el botón y hacer clic de nuevo
    trabajos_button = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, '//a[@data-testid="app-header-jobs-menu-item"]'))
    )
    trabajos_button.click()

# Una vez estamos aquí, hemos de posicionarnos para buscar las posiciones deseadas, para ello debemos aplicar la búsqueda:
busqueda_element = WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.XPATH, '//div[@class="search-switch__item flex gap-1 items-center search-switch__item_active"]'))
)
busqueda_element.click()

#############################

# Lista de posiciones a buscar
posiciones = ["Analista de datos", "Controller", "Data Analyst", "Analista Power BI", "Data Scientist", "Data Science","Web Developer"]
posiciones_data = []

# Iteramos sobre la lista de posiciones
for posicion in posiciones:
    # Esperamos a que el campo de búsqueda esté presente
    search_input = WebDriverWait(driver, 5).until(
        EC.presence_of_element_located((By.XPATH, '//input[@data-testid="search-form-keyword-ui-input"]'))
    )

    # Limpiar el campo de búsqueda para la siguiente posición
    search_input.clear()

    # Enviamos la posición al campo de búsqueda
    search_input.send_keys(posicion)

    # Esperamos hasta que el botón de búsqueda esté clickable
    search_button = WebDriverWait(driver, 5).until(
        EC.element_to_be_clickable((By.XPATH, '//button[@aria-label="ui-button"]'))
    )

    # Hacemos clic en el botón de búsqueda
    search_button.click()

    # Ahora extraemos los datos de la lista de trabajos
    job_list = WebDriverWait(driver, 15).until(
        EC.presence_of_all_elements_located((By.XPATH, '//div[@class="serp-list js-serp-list"]/li'))
    )

    for job in job_list:
        title = job.find_element(By.TAG_NAME, 'h4').text if job.find_element(By.TAG_NAME, 'h4') else 'Sin título'
        company = job.find_element(By.CLASS_NAME, 'company').text if job.find_element(By.CLASS_NAME, 'company') else 'Sin empresa'
        location = job.find_element(By.CLASS_NAME, 'company-address').text if job.find_element(By.CLASS_NAME, 'company-address') else 'Sin ubicación'
        description = job.find_element(By.CLASS_NAME, 'description').text if job.find_element(By.CLASS_NAME, 'description') else 'Sin descripción'

        # Añadir el trabajo a la lista
        posiciones_data.append({
            'Título': title,
            'Empresa': company,
            'Ubicación': location,
            'Descripción': description,
            'Posición': posicion
        })

    # Limpiar el campo de búsqueda para la siguiente posición
    search_input.clear()

    # Enviamos la posición al campo de búsqueda
    search_input.send_keys(posicion)
    
    # Esperamos hasta que el botón de búsqueda esté clickable
    search_button = WebDriverWait(driver, 5).until(
        EC.element_to_be_clickable((By.XPATH, '//button[@aria-label="ui-button"]'))
    )

    # Hacemos clic en el botón de búsqueda
    search_button.click()

    # Esperamos unos segundos para que los resultados se carguen
    sleep(2)
